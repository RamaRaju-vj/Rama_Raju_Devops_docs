# 4.01 Rolling Updates and Rollbacks 

Kubernetes **Deployments** provide builtâ€‘in support for safe upgrades and fast recovery using:

- âœ… Rolling Updates â€” upgrade without downtime  
- âª Rollbacks â€” revert to a previous working version  

Each change to a Deployment creates a new **revision**, so Kubernetes can track versions and switch back if needed.

---

## ğŸ¯ What Is a Rollout

A **rollout** is triggered whenever a Deployment is created or its Pod template changes.

### A rollout happens when you:

- Create a Deployment
- Change container image
- Modify labels / env / command
- Change pod template fields

Each rollout creates:

- A new **ReplicaSet**
- A new **revision number**

!!! note
    Think of a rollout as a new version release of your Deployment inside the cluster.

---

## ğŸ§± Deployment Revision Model

Every Deployment keeps a history of ReplicaSets (versions).

```
Deployment
   â”‚
   â”œâ”€ Revision 1 â†’ ReplicaSet A â†’ Pods (v1)
   â”œâ”€ Revision 2 â†’ ReplicaSet B â†’ Pods (v2)
   â””â”€ Revision 3 â†’ ReplicaSet C â†’ Pods (v3)
```

- Only one ReplicaSet serves full traffic after rollout completes
- Older ReplicaSets are kept for rollback

!!! tip
    ReplicaSets are the â€œversion historyâ€ behind a Deployment.

---

## ğŸš€ Deployment Strategies

Kubernetes supports two upgrade strategies.

---

## ğŸ”´ Recreate Strategy

All old pods are deleted first, then new pods are created.

### Flow

```
Old Pods â†’ deleted â†’ âŒ downtime â†’ New Pods created
```

### Behavior

- Simple
- Causes application downtime
- Not default

!!! warning
    Users will experience outage during upgrade with Recreate strategy.

---

## ğŸŸ¢ Rolling Update Strategy (Default)

Pods are replaced gradually.

### Flow

```
Old: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
Step1: â–ˆâ–ˆâ–ˆâ–ˆâ–‘ + â–‘
Step2: â–ˆâ–ˆâ–ˆâ–‘â–‘ + â–ˆâ–ˆ
Step3: â–ˆâ–ˆâ–‘â–‘â–‘ + â–ˆâ–ˆâ–ˆ
New:  â–‘â–‘â–‘â–‘â–‘ + â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
```

### Behavior

- Old and new pods run together temporarily
- No downtime (if readiness probes are correct)
- Default strategy

!!! success
    RollingUpdate is used automatically if no strategy is specified.

---

## âš™ï¸ Strategy Configuration (YAML)

=== "Rolling Update (default)"

    ```yaml
    strategy:
      type: RollingUpdate
    ```

=== "Recreate"

    ```yaml
    strategy:
      type: Recreate
    ```

---

## ğŸ”„ How to Update a Deployment

You can trigger a new rollout in two main ways.

---

## Method 1 â€” Update YAML and Apply

Edit Deployment YAML, then:

```bash
kubectl apply -f deployment.yaml
```

Kubernetes will:

- Create new ReplicaSet
- Start rollout
- Create new revision

---

## Method 2 â€” Update Image Directly

```bash
kubectl set image deployment/myapp nginx=nginx:1.9.1
```

!!! tip
    Fast for quick updates, but your YAML file will not reflect this change automatically.

---

## ğŸ“Š Rollout Status and History

### Check rollout progress

```bash
kubectl rollout status deployment/myapp
```

---

### View revision history

```bash
kubectl rollout history deployment/myapp
```

Example:

```
REVISION   CHANGE-CAUSE
1          initial deploy
2          image update
```

!!! example
    Useful to identify which revision to roll back to.

---

## ğŸ§© What Happens During Rolling Update

Behind the scenes Kubernetes creates a new ReplicaSet and shifts traffic gradually.

```
Start:
ReplicaSet A â†’ 5 pods (v1)

During:
ReplicaSet A â†’ 3 pods
ReplicaSet B â†’ 2 pods

Later:
ReplicaSet A â†’ 1 pod
ReplicaSet B â†’ 4 pods

End:
ReplicaSet A â†’ 0 pods
ReplicaSet B â†’ 5 pods (v2)
```

---

## ğŸ” View ReplicaSets

```bash
kubectl get replicasets
```

You will observe:

- Old ReplicaSet scaled down
- New ReplicaSet scaled up

---

## âª Rollback a Deployment

If a new version is broken, revert instantly.

```bash
kubectl rollout undo deployment/myapp
```

Kubernetes will:

- Scale down new ReplicaSet
- Scale up previous ReplicaSet
- Restore last working version

!!! success
    Rollback is fast because old ReplicaSet already exists.

---

## âª Rollback Flow

```
Current â†’ ReplicaSet B â†’ bad version â†’ 5 pods

Rollback â†’

ReplicaSet B â†’ scaled to 0
ReplicaSet A â†’ scaled to 5

Previous version restored
```

---

## ğŸ› ï¸ Command Cheat Sheet

### Create

```bash
kubectl create -f deployment.yaml
```

### List

```bash
kubectl get deployments
```

### Update

```bash
kubectl apply -f deployment.yaml
kubectl set image deployment/myapp nginx=nginx:1.9.1
```

### Status

```bash
kubectl rollout status deployment/myapp
kubectl rollout history deployment/myapp
```

### Rollback

```bash
kubectl rollout undo deployment/myapp
```

---

## ğŸ§  Exam Tips

!!! question
    Default deployment strategy?

RollingUpdate

---

!!! question
    What creates a new revision?

Any Pod template change

---

!!! question
    Does rollback create new pods?

Yes â€” previous ReplicaSet pods are scaled up again.

---

## âœ… Quick Summary

!!! summary

    - Rollout = new Deployment revision
    - Each rollout creates a new ReplicaSet
    - RollingUpdate is default
    - Recreate causes downtime
    - rollout status shows progress
    - rollout history shows revisions
    - rollout undo restores previous version
